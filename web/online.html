<!doctype html>
<html lang="en">
<head>

	<title>=T0k3n!z3R=</title>
	<meta charset="utf-8">

	<style>
		i { font-size: 0.8em; }
		h1 { font-family: monospace; }
	</style>

	<script type="application/javascript">

		"use strict";

		function buff2hex(buffer)
		{
			return [...new Uint8Array(buffer)].map(x => x.toString(16).padStart(2, '0')).join('');
		}

		function buff2pin(token_buffer)
		{
			var hex_data = buff2hex(token_buffer);
			var hex_word = hex_data.match(/(.{1,6})/g);			
			var hexpin = parseInt(hex_word.shift(), 16);

			for (var i=0; i<hex_word.length; i++) hexpin = (hexpin ^ parseInt(hex_word[i], 16));
			return hexpin;
		}

		//---------------------------------------------------------------------------------------------------------------

		function tokenizer(auth, host, key)
		{
			const strenc = new TextEncoder('utf-8');

			const pbkdf2_pref = {name: 'PBKDF2', hash: 'SHA-256', salt: strenc.encode(key), iterations: 300000};
			const hmac_pref = {name: 'HMAC', hash: 'SHA-512'};

			return new Promise(function(resolve)
			{
				crypto.subtle.importKey('raw', strenc.encode(auth), 'PBKDF2', false, ['deriveBits'])
				.then(pbkdf2_key => crypto.subtle.deriveBits(pbkdf2_pref, pbkdf2_key, 64*8))
				.then(pbkdf2_hash => crypto.subtle.importKey('raw', strenc.encode(buff2hex(pbkdf2_hash)), hmac_pref, false, ['sign']))
				.then(hmac_key => crypto.subtle.sign('HMAC', hmac_key, strenc.encode(host)))
				.then(hmac_hash => crypto.subtle.digest('SHA-1', hmac_hash))
				.then(function(token_sha1)
				{
					var token = btoa(String.fromCharCode(...new Uint8Array(token_sha1)));
					var pin = token.substring(token.length - 4) + buff2pin(token_sha1);

					resolve({token: token, pin: pin});
				});
			})
		}

		async function digest(user, login, server, password)
		{
			const strenc = new TextEncoder('utf-8');

			const key = await crypto.subtle.digest('SHA-512', strenc.encode(password));
			const host = await crypto.subtle.digest('SHA-512', strenc.encode(login + server));
			const auth = await crypto.subtle.digest('SHA-512', strenc.encode(user + buff2hex(host)));

			return {auth: auth, host: host, key: key};
		}

		//---------------------------------------------------------------------------------------------------------------

		function getToken()
		{
			document.getElementById("token").textContent = '';
			document.getElementById("pin-token").textContent = '';

			//--# get user inputs

			var user = document.getElementById("user-name").value.trim();
			var login = document.getElementById("user-login").value.trim();
			var server = document.getElementById("host-server").value.trim();
			var password = document.getElementById("master-key").value.trim();

			//--# digest user data + token result

			digest(user, login, server, password)
			.then(hash => tokenizer(buff2hex(hash.auth), buff2hex(hash.host), buff2hex(hash.key)))
			.then(function(output)
			{
					document.getElementById("token").textContent = '!' + output.token;			
					document.getElementById("pin-token").textContent = output.pin;
			});
		}

	</script>

</head>
<body>
<h1>=T0k3n!z3R=</h1>
<span>A quick and dirty <b>password key derivation</b> tool powered by <a href="https://developer.mozilla.org/en-US/docs/Web/API/Crypto">Web Crypto API</a> <sup>(SubtleCrypto)</sup>
<br/>Only one good master password for an infinity of strong unique tokens.
<br/>No subscription - no account - no storage - no leaks - works offline &amp; from terminal</span>

<blockquote>
<i>&laquo; One Ring to rule them all, One Ring to find them, One Ring to bring them all and in the darkness bind them. &raquo;
<br/><b>— J.R.R. Tolkien</b></i>
</blockquote>

<form>
<hr/>
	<table>	

		<tr><td colspan="2"><h3>Private &amp; secret</h3></td></tr>

		<tr>
			<td>User: <i>(your name)</i></td>
			<td><input title="Your name" type="text" id="user-name" size="30" placeholder="Jones Smith" /></td>
		</tr>

		<tr>
			<td>Password: <i>(master seed or passphrase)</i></td>
			<td><input title="Master password" type="password" id="master-key" size="30" placeholder="••••• ••••• •••••" /></td>
		</tr>

		<tr><td colspan="2"><h3>Public &amp; known</h3></td></tr>

		<tr>
			<td>Login: <i>(e-mail or alias or pseudonym)</i></td>
			<td><input title="User login" type="text" id="user-login" size="30" placeholder="jsmith123 / jones.smith@email.com" /></td>
		</tr>

		<tr>
			<td>Server: <i>(domain or hostname)</i></td>
			<td><input title="Domain name" type="text" id="host-server" size="30" placeholder="website.com"/></td>
		</tr>

		<tr><td colspan="2">&nbsp;</td></tr>

		<tr>
			<td><input type="button" value="Get my token" onclick="getToken()" /> <i>(may take a while...)</i></td>
			<td><b><span title="Your credential" id="token">&infin;</span></b><br/></td>
		</tr>

		<tr><td colspan="2">&nbsp;</td></tr>

		<tr>
			<td>Alternative PIN code:</td>
			<td><b><span title="Your PIN code" id="pin-token">&infin;</span></b><br/></td>
		</tr>

	</table>

</form>
<br/>
<form>
<hr/>
<h3>Linux shell version $&gt;_</h3>

<pre>
#!/bin/bash

set +o allexport

#--[ User inputs ]------------------------------------------------------------------------------

read -p "User: " USER
read -s -p "Password: " PASS

echo -e "\n"

if ! [ -z "$1" ]; then LOGIN="$1"
else read -p "Login: " LOGIN; fi

if ! [ -z "$2" ]; then HOST="$2"
else read -p "Server: " HOST; fi

#--[ SHA512 digest inputs ]---------------------------------------------------------------------

PASS=$(echo -n "$PASS" | sha512sum | cut -d ' ' -f 1)
HOST=$(echo -n "$LOGIN$HOST" | sha512sum | cut -d ' ' -f 1)
USER=$(echo -n "$USER$HOST" | sha512sum | cut -d ' ' -f 1)

#--[ Tokenize with PBKDF2 / HMAC ]--------------------------------------------------------------

PBKDF2=$(echo -n "$USER" | nettle-pbkdf2 --iterations=300000 --length=64 "$PASS" | sed 's/ //g')
HMAC512=$(echo -n "$HOST" | openssl dgst -sha512 -hmac "$PBKDF2" | cut -d ' ' -f 2)

#--[ SHA1 + BASE64 for convenient output ]------------------------------------------------------

TOKEN=$(echo -n "$HMAC512" | xxd -r -p | sha1sum -b | cut -d ' ' -f 1 | xxd -r -p | base64 -w 0)

#--[ User output ]------------------------------------------------------------------------------

echo -e "\nToken: !$TOKEN"
</pre>

<br/><hr/>
With <a href="https://www.lysator.liu.se/~nisse/nettle/">Nettle</a> (PBKDF2) and <a href="https://www.openssl.org/">OpenSSL</a> (HMAC) into the shell
<br/><br/>Repository @ <a href="https://github.com/swannty/tokenizer">https://github.com/swannty/tokenizer</a>
</form>
<br/><br/>
</body>
</html>
